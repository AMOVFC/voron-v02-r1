[fan_generic chamber_fan]
pin: gpio18  # Replace with the actual pin for your chamber fan
max_power: 1.0
kick_start_time: 0.100
cycle_time: 0.010
hardware_pwm: False

[temperature_sensor chamber_temp]
sensor_pin: gpio26
sensor_type: NTC 100K MGB18-104F39050L32
min_temp: 10
max_temp: 80
gcode_id: C

[gcode_macro _SET_CHAMBER_FAN_SPEED]
gcode:
    {% if params.SPEED is defined %}
        {% set speed = params.SPEED|float %}
        {% if speed >= 0.0 and speed <= 1.0 %}
            SET_FAN_SPEED FAN=chamber_fan SPEED={speed}
            { action_respond_info("Chamber fan speed set to " + speed|string) }
        {% else %}
            { action_respond_info("Error: Chamber fan speed must be between 0.0 and 1.0") }
        {% endif %}
    {% else %}
        { action_respond_info("Error: SPEED parameter not specified for chamber fan.") }
    {% endif %}

[gcode_macro _CONTROL_CHAMBER_FAN]
gcode:
    {% set bed_temp = printer.heater_bed.temperature|float %}
    {% set chamber_temp = printer.temperature_sensor.chamber_temp.temperature|float %}
    {% set target_chamber_temp = 45.0 %}  ; Replace with your desired chamber temperature
    {% set temp_threshold_high = target_chamber_temp + 5 %} ; Adjust as needed
    {% set temp_threshold_low = target_chamber_temp - 2 %}  ; Adjust as needed
    {% set max_fan_speed = 0.8 %}        ; Adjust the maximum fan speed
    {% set min_fan_speed = 0.2 %}        ; Adjust the minimum fan speed

    {% if bed_temp >= 60 %} ; Example bed temperature to start increasing fan
        {% if chamber_temp < target_chamber_temp %}
            ; Increase fan speed based on bed temperature and chamber temperature difference
            {% set speed = ((bed_temp - 60) / (110 - 60)) * max_fan_speed %} ; Example scaling
            {% if speed > max_fan_speed %}
                {% set speed = max_fan_speed %}
            {% endif %}
            {% if speed < min_fan_speed %}
                {% set speed = min_fan_speed %}
            {% endif %}
            _SET_CHAMBER_FAN_SPEED SPEED={speed}
        {% elif chamber_temp > temp_threshold_high %}
            ; Chamber too hot, reduce fan speed
            _SET_CHAMBER_FAN_SPEED SPEED={min_fan_speed}
        {% elif chamber_temp < temp_threshold_low %}
            ; Chamber too cold, increase fan slightly if bed is hot
            {% if bed_temp >= 70 %}
                _SET_CHAMBER_FAN_SPEED SPEED={min_fan_speed + 0.1} ; Small increase
            {% else %}
                _SET_CHAMBER_FAN_SPEED SPEED=0.0
            {% endif %}
        {% else %}
            ; Chamber near target, maintain a moderate speed
            _SET_CHAMBER_FAN_SPEED SPEED={min_fan_speed + 0.2} ; Adjust as needed
        {% endif %}
    {% else %}
        ; Bed not hot enough, turn off chamber fan
        _SET_CHAMBER_FAN_SPEED SPEED=0.0
    {% endif %}

[gcode_macro _START_CHAMBER_FAN_CONTROL]
gcode:
    ; Start a background task to periodically control the chamber fan
    UPDATE_DELAYED_GCODE ID=control_chamber_fan DURATION=5

[delayed_gcode control_chamber_fan]
gcode:
    _CONTROL_CHAMBER_FAN
    UPDATE_DELAYED_GCODE ID=control_chamber_fan DURATION=5

[gcode_macro CHAMBER_BED_HEAT]
gcode:
    { action_respond_info("BED_TEMP parameter received: " + params.S|string) }
    {% if params.S is defined %}
        M140 S{params.S} ; Set bed temperature (no wait)
        {% if params.S|float >= 40 %} ; Example threshold to start fan control
            _START_CHAMBER_FAN_CONTROL
        {% endif %}
    {% else %}
        { action_respond_info("Error: Temperature (S) parameter is required for CHAMBER_BED_HEAT.") }
    {% endif %}

[gcode_macro CHAMBER_BED_WAIT]
gcode:
    {% if params.CT is defined %}
        {% set chamber_target = params.CT|float %}
        { action_respond_info("Waiting for chamber temperature to reach " + chamber_target|string + "°C") }
        TEMPERATURE_WAIT SENSOR=chamber_temp MINIMUM={chamber_target - 2} MAXIMUM={chamber_target + 2}
        { action_respond_info("Chamber temperature reached " + printer.temperature_sensor.chamber_temp.temperature|string + "°C") }
        {% if printer.heater_bed.target >= 40 %} ; Example threshold to ensure bed is also heating
            _START_CHAMBER_FAN_CONTROL
        {% endif %}
    {% else %}
        { action_respond_info("Error: Chamber Target Temperature (CT) parameter is required for CHAMBER_BED_WAIT.") }
    {% endif %}
