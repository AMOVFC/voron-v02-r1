[fan_generic chamber_fan]
pin: gpio18  # Replace with the actual pin for your chamber fan
max_power: 1.0
kick_start_time: 0.100
cycle_time: 0.010
hardware_pwm: False

[temperature_sensor chamber_temp]
sensor_pin: gpio26
sensor_type: Generic 3950 #NTC 100K MGB18-104F39050L32
min_temp: 10
max_temp: 80
gcode_id: C
    
[gcode_macro CHAMBER_AUTO_HEAT]
gcode:
      {% set target_chamber = printer.configfile.config.temperature_sensor.chamber_temp.max_temp|default(45)|float %} ; Default to max_temp or 45°C
          {% set target_chamber = params.TARGET|float %}

      {% if target_chamber > 30 %}
          # { action_respond_info("Initiating automatic chamber heating to " + target_chamber|string + "°C.") }
          SET_FAN_SPEED FAN=chamber_fan SPEED=0.8
          WAIT_FOR_CHAMBER_TEMP TARGET={target_chamber} TOLERANCE=2
          SET_FAN_SPEED FAN=chamber_fan SPEED=0.6
          # { action_respond_info("Chamber reached target. Fan speed reduced to 60%.") }
      {% else %}
          # { action_respond_info("No valid target chamber temperature defined or provided. Skipping chamber auto-heat.") }
          SET_FAN_SPEED FAN=chamber_fan SPEED=0.0
      {% endif %}
      
              TEMPERATURE_WAIT SENSOR=chamber_temp MINIMUM={target_chamber - wait_tolerance} MAXIMUM={target_chamber + wait_tolerance}

[gcode_macro WAIT_FOR_CHAMBER_TEMP]
gcode:
    # {% if params.TARGET is defined %}
        {% set target_chamber = params.TARGET|float %}
        {% set wait_tolerance = params.TOLERANCE|default(2)|float %} ; Default tolerance of 2°C
        # { action_respond_info("Waiting for chamber temperature to reach " + target_chamber|string + "°C (±" + wait_tolerance|string + "°C)") }
        # { action_respond_info("Chamber temperature reached " + printer.temperature_sensor.chamber_temp.temperature|string + "°C") }
    # {% else %}
        # { action_respond_info("Error: TARGET parameter is required for WAIT_FOR_CHAMBER_TEMP.") }
    # {% endif %}